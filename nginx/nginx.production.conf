# Configuration Nginx pour le projet Train Routing System
# À inclure dans la configuration principale de votre serveur
# Exemple: include /opt/train-routing/nginx/nginx.production.conf;

# Upstream pour le backend
upstream train_routing_backend {
    server localhost:8001;  # Port interne du backend (à adapter selon votre configuration)
    keepalive 32;
}

# Upstream pour le frontend (si servi directement)
upstream train_routing_frontend {
    server localhost:5174;  # Port interne du frontend (à adapter selon votre configuration)
    keepalive 32;
}

# Configuration pour /projets/train-routing-system
location /projets/train-routing-system {
    # Redirection pour supprimer le trailing slash
    rewrite ^/projets/train-routing-system$ /projets/train-routing-system/ permanent;
    
    # Proxy vers le frontend
    proxy_pass http://train_routing_frontend/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Prefix /projets/train-routing-system;
    
    # WebSocket support (pour le hot-reload en dev)
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Buffer settings
    proxy_buffering off;
    proxy_request_buffering off;
}

# API Backend pour /projets/train-routing-system/api
location /projets/train-routing-system/api {
    # Supprimer le préfixe /projets/train-routing-system avant de passer au backend
    rewrite ^/projets/train-routing-system/api(.*)$ /api$1 break;
    
    proxy_pass http://train_routing_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Prefix /projets/train-routing-system;
    
    # CORS headers (si nécessaire)
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
    
    if ($request_method = OPTIONS) {
        return 204;
    }
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# Assets statiques (logo, images, etc.)
location /projets/train-routing-system/logo {
    alias /opt/train-routing/frontend/dist/logo;
    expires 30d;
    add_header Cache-Control "public, immutable";
    access_log off;
}

# Assets statiques générés (JS, CSS)
location ~* ^/projets/train-routing-system/assets/ {
    proxy_pass http://train_routing_frontend;
    expires 1y;
    add_header Cache-Control "public, immutable";
    access_log off;
}

